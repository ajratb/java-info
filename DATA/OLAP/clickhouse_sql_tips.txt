

в конце скрипта добавляй это
     settings
  receive_timeout = 86400000,
  send_timeout = 86400000,
  distributed_product_mode = 'allow';

Насчет запросов, которые бегут часами:
среда может показывать, что запрос бежит, хотя по факту он давно упал. Для проверки можно параллельно со своим с запросом с другой странички запустить
 select * from system.processes

 Так мы увидим все активные запросы и сможем посмотреть, есть ли наш их в числе
сам запрос отображается в колонке query

